package com.newsportal.controller;

import com.newsportal.dao.CategoryDAO;
import com.newsportal.model.Category;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.*;

import java.io.IOException;
import java.util.List;

@WebServlet("/admin/categories")
public class CategoryCRUDServlet extends HttpServlet {
  private final CategoryDAO dao = new CategoryDAO();

  @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    String action = p(req, "action", "list");
    if ("edit".equals(action)) {
      long id = Long.parseLong(req.getParameter("id"));
      req.setAttribute("item", dao.findById(id));
    }
    list(req, resp);
  }

  @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("UTF-8");
    String action = p(req, "action", "list");
    switch (action) {
      case "create": {
        Category c = new Category();
        c.setName(req.getParameter("name"));
        c.setSlug(req.getParameter("slug"));
        dao.create(c);
        break;
      }
      case "update": {
        long id = Long.parseLong(req.getParameter("id"));
        Category c = dao.findById(id);
        c.setName(req.getParameter("name"));
        c.setSlug(req.getParameter("slug"));
        dao.update(c);
        break;
      }
      case "delete": {
        long id = Long.parseLong(req.getParameter("id"));
        dao.delete(id);
        break;
      }
    }
    resp.sendRedirect(req.getContextPath()+"/admin/categories");
  }

  private void list(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    List<Category> items = dao.findAll();
    req.setAttribute("items", items);
    req.getRequestDispatcher("/WEB-INF/views/admin/categories.jsp").forward(req, resp);
  }

  private String p(HttpServletRequest r, String k, String d){ String v=r.getParameter(k); return (v==null||v.isBlank())?d:v.trim(); }
}
