<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c"  uri="jakarta.tags.core" %>
<%@ taglib prefix="fn" uri="jakarta.tags.functions" %>

<%@ include file="layout/header.jsp" %>

<main class="container grid">
  <!-- CỘT TRÁI -->
  <section class="content">
    <h1>Chuyên mục: <c:out value="${currentCategory.name}"/></h1>

    <c:choose>
      <c:when test="${empty news}">
        <div class="card" style="padding:16px;">Chưa có bài viết nào trong chuyên mục này.</div>
      </c:when>
      <c:otherwise>
        <div class="list-posts">
          <c:forEach var="n" items="${news}">
            <c:set var="ctx" value="${pageContext.request.contextPath}"/>
            <c:set var="img" value="${n.image}"/>

            <!-- Build URL ảnh an toàn (tuyệt đối/ tương đối/ rỗng) -->
            <c:set var="imgUrl"
                   value="${
                     empty img
                       ? ctx + '/assets/img/sample.jpg'
                       : (img.startsWith('http')
                            ? img
                            : (img.startsWith('/') ? ctx + img : ctx + '/' + img))
                   }"/>

            <article class="card post-row">
              <a class="thumb" href="${ctx}/news/${n.id}">
                <img src="${imgUrl}" alt="${fn:escapeXml(n.title)}" loading="lazy">
              </a>

              <div class="body">
                <h3 class="title">
                  <a href="${ctx}/news/${n.id}">
                    <c:out value="${n.title}"/>
                  </a>
                </h3>

                <p class="excerpt">
                  <c:out value="${fn:length(n.content) > 180 ? fn:substring(n.content,0,180).concat('…') : n.content}"/>
                </p>

                <div class="meta">
                  <span>${n.viewCount} lượt xem</span>
                  <c:if test="${not empty n.postedDate}">
                    <span>• ${n.postedDate}</span>
                  </c:if>
                </div>
              </div>
            </article>
          </c:forEach>
        </div>
      </c:otherwise>
    </c:choose>

    <!-- Phân trang (tùy chọn: nếu controller set page & totalPages) -->
    <c:if test="${not empty page && not empty totalPages && totalPages > 1}">
      <nav class="pagination">
        <c:set var="baseUrl" value='${pageContext.request.contextPath}/category?id=${currentCategory.id}'/>
        <a class="page ${page==1 ? 'disabled' : ''}" href="${baseUrl}&page=${page-1}">Trước</a>

        <c:forEach var="i" begin="1" end="${totalPages}">
          <a class="page ${i==page ? 'active' : ''}" href="${baseUrl}&page=${i}">${i}</a>
        </c:forEach>

        <a class="page ${page==totalPages ? 'disabled' : ''}" href="${baseUrl}&page=${page+1}">Sau</a>
      </nav>
    </c:if>
  </section>

  <!-- CỘT PHẢI -->
  <aside>
    <jsp:include page="layout/sidebar.jsp"/>
  </aside>
</main>

<%@ include file="layout/footer.jsp" %>
