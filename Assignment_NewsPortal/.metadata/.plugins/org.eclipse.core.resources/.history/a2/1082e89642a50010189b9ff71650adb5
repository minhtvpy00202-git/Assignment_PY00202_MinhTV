<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@ include file="layout/header.jsp"%>
<%@ taglib prefix="fn" uri="jakarta.tags.functions"%>




<div class="home-wrap">

	<div class="home-grid">

		<!-- CỘT TRÁI: THAY ĐỔI THEO TRANG -->
		<section class="home-main">
			<!-- bài Trang Nhất-->
			<div class="content">

				<c:if test="${empty approvedNews}">
					<p>Chưa có bài viết nào được duyệt.</p>
				</c:if>

				<div class="news-list">
					<c:forEach var="n" items="${approvedNews}">
						<!-- Build URL ảnh an toàn -->
						<c:set var="ctx" value="${pageContext.request.contextPath}" />
						<c:set var="ctxSlash" value="${ctx}/" />
						<c:set var="img" value="${n.image}" />

						<c:choose>
							<c:when test="${empty img}">
								<c:set var="imgUrl" value="${ctx}/assets/img/sample.jpg" />
							</c:when>
							<c:when test="${fn:startsWith(img,'http')}">
								<c:set var="imgUrl" value="${img}" />
							</c:when>
							<c:when test="${fn:startsWith(img, ctxSlash)}">
								<c:set var="imgUrl" value="${img}" />
							</c:when>
							<c:when test="${fn:startsWith(img,'/')}">
								<c:set var="imgUrl" value="${ctx}${img}" />
							</c:when>
							<c:otherwise>
								<c:set var="imgUrl" value="${ctx}/${img}" />
							</c:otherwise>
						</c:choose>

						<!-- Rút gọn nội dung -->
						<c:set var="excerpt" value="${n.content}" />
						<c:if test="${fn:length(excerpt) > 160}">
							<c:set var="excerpt" value="${fn:substring(excerpt,0,160)}..." />
						</c:if>

						<!-- Item -->
						<article class="post-row">
							<a class="thumb" href="news-detail?id=${n.id}"> <img
								src="${imgUrl}" alt="${fn:escapeXml(n.title)}" loading="lazy">
							</a>
							<div class="body">
								<h3 class="title">
									<a href="news-detail?id=${n.id}"><c:out value="${n.title}" /></a>
								</h3>
								<p class="excerpt">
									<c:out value="${excerpt}" escapeXml="false" />
								</p>
								<div class="meta">
									<span>Đăng ngày: ${n.postedDate}</span>
									<c:if test="${not empty n.author}">
										<span> | ${n.author}</span>
									</c:if>
								</div>
							</div>
						</article>
					</c:forEach>
				</div>
			</div>


		</section>

		<!-- CỘT PHẢI: 3 KHỐI + NEWSLETTER -->
		<aside>

			<!-- 5 bản tin được xem nhiều -->
			<div class="panel">
				<div class="panel-h yellow">5 bản tin được xem nhiều</div>
				<div class="panel-b">
					<ul>
						<c:forEach var="n" items="${hotList}" varStatus="st">
							<li><a
								href="${pageContext.request.contextPath}/news/${n.id}"> <c:out
										value="${st.index + 1}" />. ${n.title}
							</a></li>
						</c:forEach>
						<c:if test="${empty hotList}">
							<li>Chưa có dữ liệu.</li>
						</c:if>
					</ul>
				</div>
			</div>

			<!-- 5 bản tin mới nhất -->
			<div class="panel">
				<div class="panel-h gray">5 bản tin mới nhất</div>
				<div class="panel-b">
					<ul>
						<c:forEach var="n" items="${newList}" varStatus="st">
							<li><a
								href="${pageContext.request.contextPath}/news/${n.id}"> <c:out
										value="${st.index + 1}" />. ${n.title}
							</a></li>
						</c:forEach>
						<c:if test="${empty newList}">
							<li>Chưa có dữ liệu.</li>
						</c:if>
					</ul>
				</div>
			</div>

			<!-- 5 bản tin bạn đã xem -->
			<div class="panel">
				<div class="panel-h green">5 bản tin bạn đã xem</div>
				<div class="panel-b">
					<ul>
						<c:forEach var="n" items="${recentList}" varStatus="st">
							<li><a
								href="${pageContext.request.contextPath}/news/${n.id}"> <c:out
										value="${st.index + 1}" />. ${n.title}
							</a></li>
						</c:forEach>
						<c:if test="${empty recentList}">
							<li>Chưa có lịch sử xem.</li>
						</c:if>
					</ul>
				</div>
			</div>

			<!-- Newsletter -->
			<div class="panel">
				<div class="panel-b">
					<form method="post"
						action="${pageContext.request.contextPath}/newsletter/subscribe">
						<input type="email" name="email" placeholder="Nhập Email đăng ký"
							required>
						<button type="submit">Đăng ký</button>
					</form>
				</div>
			</div>
			<c:if test="${not empty param.sub_msg}">
  <div class="alert success">${param.sub_msg}</div>
</c:if>

		</aside>
	</div>
</div>

<%@ include file="layout/footer.jsp"%>
