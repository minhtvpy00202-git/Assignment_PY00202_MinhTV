package com.newsportal.controller;

import com.newsportal.dao.CategoryDAO;
import com.newsportal.dao.NewsDAO;
import com.newsportal.model.News;
import com.newsportal.model.User;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.*;

import java.io.IOException;
import java.util.List;

@WebServlet("/admin/news")
@MultipartConfig(maxFileSize = 10*1024*1024, maxRequestSize = 50*1024*1024)
public class AdminNewsCRUDServlet extends HttpServlet {
  private final NewsDAO newsDAO = new NewsDAO();
  private final CategoryDAO categoryDAO = new CategoryDAO();

  @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    String action = p(req, "action", "list");
    if ("edit".equals(action)) {
      long id = Long.parseInt(req.getParameter("id"));
      req.setAttribute("item", newsDAO.findById(id));
    }
    list(req, resp);
  }

  @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("UTF-8");
    String action = p(req, "action", "list");
    switch (action) {
      case "create": {
        News n = bind(req, new News());
        newsDAO.create(n);
        break;
      }
      case "update": {
        long id = Long.parseLong(req.getParameter("id"));
        News n = bind(req, newsDAO.findById(id));
        newsDAO.update(n);
        break;
      }
      case "delete": {
        long id = Long.parseLong(req.getParameter("id"));
        newsDAO.delete(id);
        break;
      }
    }
    resp.sendRedirect(req.getContextPath()+"/admin/news");
  }

  private void list(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    List<News> items = newsDAO.findAll(); // nếu bạn có view model kèm categoryName/authorName thì thay bằng hàm đó
    req.setAttribute("items", items);
    req.setAttribute("categories", categoryDAO.findAll());
    req.getRequestDispatcher("/WEB-INF/views/admin/news.jsp").forward(req, resp);
  }

  private News bind(HttpServletRequest req, News n) throws IOException, ServletException {
    n.setTitle(req.getParameter("title"));
    n.setCategoryId(Long.parseLong(req.getParameter("categoryId")));
    n.setContent(req.getParameter("content"));

    // lấy author từ session
    User u = (User) req.getSession().getAttribute("authUser");
    if (u != null) n.setAuthorId(u.getId());

    // upload ảnh nếu bạn có cột thumbnail
    Part thumb = req.getPart("thumbnail");
    if (thumb != null && thumb.getSize() > 0) {
      // TODO: lưu file vào /uploads và set n.setThumbnailPath(path)
    }
    return n;
  }

  private String p(HttpServletRequest r, String k, String d) {
    String v = r.getParameter(k);
    return (v==null || v.isBlank())? d : v.trim();
  }
}
